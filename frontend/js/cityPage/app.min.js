function individualPage() {
  async function init() {
    const data = await getData();
    const locations = await getLocations();
    const dataItems = data.items;
    const cities = globalCities;
    const teamCategories = [
      { Name: 'Head Office', Color: '#f7ea48' },
      { Name: 'Warehouse', Color: '#6ad1e3' },
      { Name: 'HGV/LGV Transport', Color: '#fb83ad' },
      { Name: 'Customer Delivery', Color: '#49c5b1' },
    ];
    const city_map = new Map();
    cities.forEach((city) => {
      const key = city.Name;
      if (!city_map.has(key)) {
        city_map.set(key, []);
      }
      city_map.get(key).push({ lat: city.Latitude, lan: city.Longitude });
    });
    const teamCat_map = new Map();
    teamCategories.forEach((cat) => {
      const key = cat.Name;
      teamCat_map.set(key, cat.Color);
    });
    const enrichedSubLocation = locations.map((loc) => ({
      ...loc,
      cityCoords: city_map.get(loc.City) || [],
      color: teamCat_map.get(loc.Category) || null,
    }));
    const subLoc_map = new Map();
    enrichedSubLocation.forEach((loc) => {
      const key = loc.Code;
      if (!subLoc_map.has(key)) {
        subLoc_map.set(key, []);
      }
      subLoc_map.get(key).push(loc);
    });
    const allJobs = dataItems.map((job) => ({
      ...job,
      subLocation: subLoc_map.get(job.location.location_code) || [],
    }));
    addingCityJobs(allJobs);
    observeMapSection(dataItems, locations, cities);
    await globalScrollAnimation();
    addingNumToCards();
  }
  init();
  let mapboxLoaded = !1;
  function loadMapbox(callback) {
    if (mapboxLoaded) {
      callback();
      return;
    }
    mapboxLoaded = !0;
    const script = document.createElement('script');
    script.src = 'https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js';
    script.defer = !0;
    script.onload = callback;
    document.body.appendChild(script);
  }
  function observeMapSection(dataItems, locations, cities) {
    const mapSection = document.querySelector('#map-canva');
    if (!mapSection) return;
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          loadMapbox(() => {
            map(dataItems, locations, cities);
          });
          observer.disconnect();
        }
      },
      { rootMargin: '200px' },
    );
    observer.observe(mapSection);
  }
  function map(jobData, locations, cities) {
    const mapCanva = document.querySelector('#map-canva');
    const accessToken =
      'pk.eyJ1IjoiaGxhYnMiLCJhIjoiY2w1d2JqeHZlMGR6eTNibTViZ3czc28ycyJ9.p5A4twIQJID-f1Tci32wWA';
    const hStyle = 'mapbox://styles/hlabs/cmj7a440w000f01s929gs8c9d';
    const searchTemplate = document.getElementById('search-template');
    const bodyAttr = document
      .querySelector('body')
      .getAttribute('city-name')
      .toLowerCase();
    const jobMap = new Map();
    jobData.forEach((job) => {
      const key = job.location.location_code;
      if (!jobMap.has(key)) {
        jobMap.set(key, []);
      }
      jobMap.get(key).push(job);
    });
    const enrichedLocation = locations.map((loc) => ({
      ...loc,
      allJobs: jobMap.get(loc.Code) || [],
    }));
    const enrichedMap = new Map();
    enrichedLocation.forEach((loc) => {
      const key = loc.City;
      if (!enrichedMap.has(key)) {
        enrichedMap.set(key, []);
      }
      enrichedMap.get(key).push(loc);
    });
    cities.forEach((city) => {
      city.locations = enrichedMap.get(city.Name) || [];
    });
    const InnerLocations = cities.find((cityName) => {
      const city = cityName?.Name.toLowerCase();
      return city === bodyAttr;
    });
    let mapLocations = { type: 'FeatureCollection', features: [] };
    let selectedMapLocations = [];
    mapboxgl.accessToken = accessToken;
    const isMobile = window.innerWidth <= 768;
    const map = new mapboxgl.Map({
      container: mapCanva,
      style: hStyle,
      center: [InnerLocations.Longitude, InnerLocations.Latitude],
      zoom: isMobile ? 12.0 : 12.0,
      minZoom: 5,
      maxZoom: 18,
      attributionControl: !1,
    });
    map.scrollZoom.disable();
    const logo = document.querySelector('.mapboxgl-ctrl-logo');
    if (logo) logo.remove();
    const zoomControl = new mapboxgl.NavigationControl({
      showZoom: !0,
      showCompass: !1,
    });
    map.addControl(zoomControl, 'bottom-right');
    const cityMarkers = [];
    function getGeoData() {
      InnerLocations.locations.forEach((loc, i) => {
        const coordinates = { lng: loc.Logtitude, lat: loc.Latitude };
        const cityName = loc.Name;
        let arrayID = i + 1 - 1;
        let geoData = {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: coordinates },
          properties: {
            arrayID: arrayID,
            cityName: cityName,
            allJobs: loc.allJobs,
            address: loc['Address Line 1'],
          },
        };
        if (mapLocations.features.includes(geoData) === !1) {
          mapLocations.features.push(geoData);
        }
      });
    }
    function addMapPoints() {
      let missingData = [];
      const icon =
        'https://cdn.prod.website-files.com/691db317d5523108e489fad8/6925c33b02c9af6561d992cf_Location%20Pin.svg';
      mapLocations.features.forEach((location) => {
        const { coordinates } = location.geometry;
        const { arrayID, cityName, coords, allJobs, address } =
          location.properties;
        if (allJobs.length === 0) return;
        const cityEl = document.createElement('div');
        cityEl.className = 'map-marker is--inner';
        cityEl.style.position = 'absolute';
        const imgElement = searchTemplate.content
          .cloneNode(!0)
          .querySelector('[map-marker]');
        cityEl.append(imgElement);
        cityEl.setAttribute('data-marker-id', `marker-${arrayID}`);
        cityEl.setAttribute('location-name', `${cityName}`);
        if (!coordinates) {
          missingData.push(placeName);
          return;
        }
        const cityMarker = new mapboxgl.Marker(cityEl)
          .setLngLat(coordinates)
          .addTo(map);
        cityMarkers.push({
          marker: cityMarker,
          markerEl: cityEl,
          arrayID,
          cityName,
        });
        cityEl.addEventListener('click', () => {
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            event: 'map_pin_click',
            place_name: arrayID,
          });
        });
        const jobArray = Array.isArray(allJobs) ? allJobs : [];
        if (!jobArray) return;
        const popup = new mapboxgl.Popup({ closeButton: !0, closeOnClick: !0 });
        const addingPopup = popup
          .setLngLat(coordinates)
          .setHTML(getPopupHtml(address, jobArray));
        function popupMediaQuery() {
          const desktopMedia = window.innerWidth > 991;
          cityEl.addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelectorAll('.mapboxgl-popup').forEach((p) => {
              p.remove();
            });
            addingPopup.addTo(map);
            cityEl.style.zIndex = '3';
          });
        }
        popupMediaQuery();
      });
    }
    function getPopupHtml(address, jobArray) {
      const jobList = jobArray
        .map((a) => {
          const category = a.job_family?.job_family_name || '';
          const applicationURL = `${a.application_url.split('/apply')[0]}/?utm_source=caraffi&utm_medium=careerssite`;
          return `
                <li category="${category}" class="popup_vac-list-item">
                   <a href=${applicationURL} target="_blank" class="popup_vac-link">${a.title}</a>
                </li>
                `;
        })
        .join('');
      return `
                <div class="popup-box_inner"><div class="popup-box_logo"><img   
                src="https://cdn.prod.website-files.com/691db317d5523108e489fad8/69258ded2f4eac43ffca5f1b_ocado-logo.svg" loading="lazy" alt=""></div>
                <div class="popup-box_content">
                <div>${address}</div>
                <div class="popup-box_vac">
                <div class="popup-box-header">Vacancies</div>
                <ul role="list" class="popup-box_vac-list">
                ${jobList}
                </ul>
                </div>
                </div></div>
        `;
    }
    getGeoData();
    let totalJobs = 0;
    mapLocations.features.forEach((loc) => {
      const lengthOfJobs = loc.properties.allJobs.length;
      totalJobs += lengthOfJobs;
    });
    if (totalJobs === 0) {
      const mapSec = document.querySelector('.map-section');
      mapSec.style.display = 'none';
    } else {
      addMapPoints();
    }
  }
  function addingCityJobs(allJobs) {
    const body = document.querySelector('body');
    let bodyAttr = body.getAttribute('city-name');
    const filteredJobs = allJobs.filter((job) => {
      const city = job.subLocation[0]?.City.toLowerCase();
      return city === bodyAttr.toLowerCase();
    });
    const swiperComp = document.querySelector("[swiper-component='city-jobs']");
    const swiperWrap = swiperComp.querySelector('.swiper-wrapper');
    const swiperItem = swiperComp.querySelector('.swiper-slide');
    const noJobCard = document.querySelector('.no-job-card');
    swiperItem.remove();
    if (filteredJobs.length === 0) {
      noJobCard.style.display = 'flex';
      noJobCard.style.opacity = '1';
      const jobSectionPadding = document.querySelector(
        '.job-2col-section .padding-vertical',
      );
      jobSectionPadding.classList.add('is--bottom-0px');
      return;
    }
    filteredJobs.forEach((job) => {
      const newItem = swiperItem.cloneNode(!0);
      const card = newItem.querySelector('.search-item');
      const job_name = card.querySelector('[search-field="job-name"]');
      const job_type = card.querySelector('[search-field="job-type"]');
      const job_category = card.querySelector('[search-field="category"]');
      const locationName = card.querySelector('[search-field="location-name"]');
      const date = card.querySelector('[search-field="date-posted"]');
      const applyLink = card.querySelector('.cta-link');
      const job_categoryWrap = job_category.parentNode;
      const newUrl = `${job.application_url.split('/apply')[0]}/?utm_source=caraffi&utm_medium=careerssite`;
      job_categoryWrap.style.background = job.subLocation[0]?.color;
      job_name.innerHTML = job.title;
      locationName.innerHTML = job.subLocation[0]?.Name;
      job_type.innerHTML = job.job_schedule.replace('_', ' ');
      job_category.innerHTML = job.subLocation[0]?.Category;
      date.innerHTML = formatCreatedAgo(job.creation_date);
      applyLink.href = newUrl;
      swiperWrap.appendChild(newItem);
    });
    citySlider();
  }
  function citySlider() {
    const swiperComponent = document.querySelector(
      "[swiper-component='city-jobs']",
    );
    const swiperContainer = swiperComponent.querySelector('.swiper');
    const nextEl = swiperComponent.querySelector('.swiper-arrow.is--next');
    const prevEl = swiperComponent.querySelector('.swiper-arrow.is--prev');
    const pagination = swiperComponent.querySelector('.swiper-pagination');
    const bullet = swiperComponent.querySelector('.swiper-bullet');
    const swiperComp = new Swiper(swiperContainer, {
      a11y: false,
      slidesPerView: 'auto',
      followFinger: !0,
      slideActiveClass: 'is-active',
      spaceBetween: 20,
      navigation: {
        nextEl: nextEl,
        prevEl: prevEl,
        disabledClass: 'is--disabled',
      },
    });
  }
  function addingNumToCards() {
    const allCards = document.querySelectorAll('.why-join_card');
    if (!allCards) return;
    allCards.forEach((card, index) => {
      const tag = card.querySelector('.num-tag');
      tag.innerHTML = `0${index + 1}`;
    });
  }
}
individualPage();
